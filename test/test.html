<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Customer Portal</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: 'Poppins', sans-serif;
      background: #f5f7fa;
      color: #2d3748;
    }
    
    .dashboard {
      display: flex;
      min-height: 100vh;
    }
    
    .sidebar {
      width: 260px;
      background: #ffffff;
      border-right: 1px solid #e2e8f0;
      padding: 24px 0;
      display: flex;
      flex-direction: column;
    }
    
    .logo {
      padding: 0 24px 24px;
      border-bottom: 1px solid #e2e8f0;
      margin-bottom: 24px;
    }
    
    .logo h2 {
      font-size: 18px;
      font-weight: 600;
      color: #1a202c;
    }
    
    .logo p {
      font-size: 13px;
      color: #718096;
      margin-top: 4px;
    }
    
    .sidebar ul {
      list-style: none;
      padding: 0 12px;
      flex: 1;
    }
    
    .sidebar li {
      margin-bottom: 4px;
    }
    
    .sidebar a {
      text-decoration: none;
      color: #4a5568;
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 10px 16px;
      border-radius: 8px;
      transition: all 0.2s;
      font-size: 14px;
      font-weight: 500;
    }
    
    .sidebar a:hover {
      background: #f7fafc;
      color: #2d3748;
    }
    
    .sidebar a.active {
      background: #edf2f7;
      color: #4299e1;
    }
    
    .btn-logout {
      margin: 24px 12px 0;
      padding: 10px 16px;
      background: #fff;
      color: #e53e3e;
      border: 1px solid #feb2b2;
      border-radius: 8px;
      text-align: center;
      display: block;
      text-decoration: none;
      font-size: 14px;
      font-weight: 500;
      transition: all 0.2s;
    }
    
    .btn-logout:hover {
      background: #fff5f5;
    }
    
    .main-content {
      flex: 1;
      padding: 32px;
      overflow-y: auto;
    }
    
    h1 {
      font-size: 28px;
      font-weight: 600;
      color: #1a202c;
      margin-bottom: 24px;
    }
    
    .btn {
      padding: 10px 20px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
      transition: all 0.2s;
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }
    
    .btn-primary {
      background: #4299e1;
      color: white;
    }
    
    .btn-primary:hover {
      background: #3182ce;
    }
    
    .btn-success {
      background: #48bb78;
      color: white;
    }
    
    .btn-success:hover {
      background: #38a169;
    }
    
    .card {
      background: white;
      border-radius: 12px;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
      padding: 24px;
      margin-top: 20px;
    }
    
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
      background: white;
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    }
    
    th, td {
      padding: 14px 16px;
      text-align: left;
      border-bottom: 1px solid #e2e8f0;
      font-size: 14px;
    }
    
    th {
      background: #e2e8f0;
      color: #4a5568;
      font-weight: 600;
      font-size: 13px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    tr:last-child td {
      border-bottom: none;
    }
    
    tr:hover {
      background: #f7fafc;
    }
    
    .content-section {
      display: none;
    }
    
    .content-section.active {
      display: block;
    }
    
    form {
      background: white;
      padding: 24px;
      border-radius: 12px;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
      margin-top: 20px;
    }
    
    form input, form select, form textarea {
      width: 100%;
      padding: 12px;
      margin-bottom: 16px;
      border: 1px solid #e2e8f0;
      border-radius: 8px;
      font-size: 14px;
      transition: all 0.2s;
    }
    
    form input:focus, form select:focus, form textarea:focus {
      outline: none;
      border-color: #4299e1;
      box-shadow: 0 0 0 3px rgba(66, 153, 225, 0.1);
    }
    
    form textarea {
      min-height: 100px;
      resize: vertical;
      font-family: inherit;
    }
    
    form input[readonly] {
      background: #f7fafc;
      cursor: not-allowed;
    }
    
    .empty-state {
      text-align: center;
      padding: 48px 24px;
      color: #718096;
    }
    
    .empty-state p {
      font-size: 15px;
      margin-top: 8px;
    }
  </style>
</head>
<body>
<div class="dashboard">
  <div class="sidebar">
    <div class="logo">
      <h2 id="welcomeText">Customer Portal</h2>
      <p id="userEmail"></p>
    </div>
    <ul>
      <li><a href="#" class="nav-link active" data-target="eventSection">ðŸ“… Events</a></li>
      <li><a href="#" class="nav-link" data-target="ticketsSection">ðŸŽ« Support Tickets</a></li>
      <li><a href="#" class="nav-link" data-target="gallerySection">ðŸ“¸ Gallery</a></li>
      <li><a href="#" class="nav-link" data-target="profileSection">ðŸ‘¤ Profile</a></li>
    </ul>
    <a href="login.html" class="btn-logout" onclick="logout()">Logout</a>
  </div>

  <div class="main-content">
    <!-- Events -->
    <div id="eventSection" class="content-section active">
      <h1>My Events</h1>
      <button class="btn btn-success" onclick="toggleEventForm()">+ Book Event</button>
      <form id="eventForm" style="display:none;">
        <input type="text" id="ename" placeholder="Your Name" readonly>
        <input type="email" id="eemail" placeholder="Your Email" readonly>
        <input type="text" id="ephone" placeholder="Phone Number" required>
        <input type="text" id="etype" placeholder="Event Type (e.g., Wedding, Birthday)" required>
        <input type="date" id="edate" required>
        <input type="time" id="etime" required>
        <input type="text" id="elocation" placeholder="Event Location" required>
        <select id="ephotographer" required>
          <option value="">Select Photographer</option>
        </select>
        <select id="epackageType" required>
          <option value="">Select Package</option>
        </select>
        <button type="submit" class="btn btn-primary">Submit Booking</button>
      </form>
      <table id="eventsTable">
        <thead>
        <tr>
          <th>Booking ID</th><th>Name</th><th>Email</th><th>Phone</th>
          <th>Event Type</th><th>Date</th><th>Time</th><th>Location</th>
          <th>Photographer</th><th>Package</th>
        </tr>
        </thead>
        <tbody id="eventsTableBody"></tbody>
      </table>
    </div>

    <!-- Tickets -->
    <div id="ticketsSection" class="content-section">
      <h1>Support Tickets</h1>
      <button class="btn btn-success" onclick="toggleTicketForm()">+ Create New Ticket</button>
      <form id="ticketForm" style="display:none;">
        <input type="text" id="tname" placeholder="Your Name" readonly>
        <input type="email" id="temail" placeholder="Your Email" readonly>
        <input type="text" id="tphone" placeholder="Phone Number" required pattern="\d{10}" title="Please enter a 10-digit phone number" maxlength="10">
        <input type="text" id="tsubject" placeholder="Subject" required>
        <textarea id="tmessage" placeholder="Describe your issue or question..." required></textarea>
        <button type="submit" class="btn btn-primary">Submit Ticket</button>
      </form>
      <table id="ticketsTable">
        <thead>
        <tr><th>Ticket ID</th><th>Name</th><th>Email</th><th>Phone</th><th>Subject</th><th>Message</th></tr>
        </thead>
        <tbody id="ticketsTableBody"></tbody>
      </table>
    </div>

    <!-- Gallery -->
    <div id="gallerySection" class="content-section">
      <h1>My Gallery</h1>
      <table id="galleryTable">
        <thead>
          <tr>
            <th>Event ID</th>
            <th>File Name</th>
            <th>Upload Date</th>
            <th>Download</th>
          </tr>
        </thead>
        <tbody id="galleryTableBody"></tbody>
      </table>
    </div>

    <!-- Profile -->
    <div id="profileSection" class="content-section">
      <h1>My Profile</h1>
      <form id="profileForm">
        <input type="text" id="pname" placeholder="Full Name" required>
        <input type="email" id="pemail" placeholder="Email" readonly>
        <input type="text" id="pphone" placeholder="Phone Number" required>
        <input type="password" id="ppassword" placeholder="New Password (leave blank to keep current)">
        <button type="submit" class="btn btn-primary">Update Profile</button>
      </form>
    </div>
  </div>
</div>

<script>
  const TICKET_API_URL = "http://localhost:9000/api/tickets";
  const EVENT_API_URL = "http://localhost:9000/api/bookings";
  const PHOTOGRAPHER_API_URL = "http://localhost:9000/api/photographers";
  const PACKAGE_API_URL = "http://localhost:9000/api/packages";
  const GALLERY_API_URL = "http://localhost:9000/zip";
  const PROFILE_API_URL = "http://localhost:9000/api/customers";

  const loggedInUser = JSON.parse(localStorage.getItem("loggedInUser"));
  if (!loggedInUser) window.location.href = "login.html";

  document.getElementById("welcomeText").textContent = "Welcome, " + (loggedInUser.uname || "Customer");
  document.getElementById("userEmail").textContent = loggedInUser.uemail || "";
  document.getElementById("ename").value = loggedInUser.uname || "";
  document.getElementById("eemail").value = loggedInUser.uemail || "";
  document.getElementById("tname").value = loggedInUser.uname || "";
  document.getElementById("temail").value = loggedInUser.uemail || "";
  document.getElementById("pname").value = loggedInUser.uname || "";
  document.getElementById("pemail").value = loggedInUser.uemail || "";
  document.getElementById("pphone").value = loggedInUser.uphone || "";

  document.addEventListener("DOMContentLoaded", function() {
    setupNavigation();
    loadEvents();
    loadTickets();
    loadPhotographers();
    loadPackages();
    loadGallery();
  });

  function setupNavigation() {
    const navLinks = document.querySelectorAll('.nav-link');
    navLinks.forEach(link => {
      link.addEventListener('click', function(e) {
        e.preventDefault();
        navLinks.forEach(l => l.classList.remove('active'));
        document.querySelectorAll('.content-section').forEach(section => section.classList.remove('active'));
        this.classList.add('active');
        document.getElementById(this.getAttribute('data-target')).classList.add('active');
      });
    });
  }

  function toggleEventForm() {
    const form = document.getElementById("eventForm");
    form.style.display = form.style.display === "none" ? "block" : "none";
  }

  async function loadPhotographers() {
    try {
      const res = await fetch(PHOTOGRAPHER_API_URL);
      const photographers = await res.json();
      const select = document.getElementById("ephotographer");
      photographers.forEach(p => {
        const option = document.createElement("option");
        option.value = p.firstName;
        option.textContent = p.firstName;
        select.appendChild(option);
      });
    } catch (err) { console.error("Failed to load photographers:", err); }
  }

  async function loadPackages() {
    try {
      const res = await fetch(PACKAGE_API_URL);
      const packages = await res.json();
      const select = document.getElementById("epackageType");
      packages.forEach(p => {
        const option = document.createElement("option");
        option.value = p.name;
        option.textContent = p.name;
        select.appendChild(option);
      });
    } catch (err) { console.error("Failed to load packages:", err); }
  }

  document.getElementById("eventForm").addEventListener("submit", async function(e) {
    e.preventDefault();
    const eventData = {
      name: loggedInUser.uname,
      email: loggedInUser.uemail,
      phone: document.getElementById("ephone").value,
      eventType: document.getElementById("etype").value,
      date: document.getElementById("edate").value,
      time: document.getElementById("etime").value,
      location: document.getElementById("elocation").value,
      photographer: document.getElementById("ephotographer").value,
      packageType: document.getElementById("epackageType").value
    };
    try {
      const res = await fetch(EVENT_API_URL, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(eventData)
      });
      if (res.ok) {
        localStorage.setItem("lastEvent", JSON.stringify(eventData));
        alert("Event created successfully!");
        window.location.href = "payment.html";
      } else {
        alert("Failed to create event");
      }
    } catch (err) { console.error(err); }
  });

  async function loadEvents() {
    try {
      const res = await fetch(EVENT_API_URL);
      const events = await res.json();
      const tbody = document.getElementById("eventsTableBody");
      tbody.innerHTML = "";
      const myEvents = events.filter(ev => ev.email === loggedInUser.uemail);
      myEvents.forEach(ev => {
        tbody.innerHTML += `<tr>
          <td>${ev.id}</td><td>${ev.name}</td><td>${ev.email}</td>
          <td>${ev.phone}</td><td>${ev.eventType}</td><td>${ev.date}</td>
          <td>${ev.time}</td><td>${ev.location}</td><td>${ev.photographer}</td><td>${ev.packageType}</td>
        </tr>`;
      });
    } catch (e) { console.error(e); }
  }

  function toggleTicketForm() {
    const form = document.getElementById("ticketForm");
    form.style.display = form.style.display === "none" ? "block" : "none";
  }

  document.getElementById("ticketForm").addEventListener("submit", async function(e) {
    e.preventDefault();
    const ticketData = {
      tname: loggedInUser.uname,
      temail: loggedInUser.uemail,
      tphone: document.getElementById("tphone").value,
      tsubject: document.getElementById("tsubject").value,
      tmessage: document.getElementById("tmessage").value
    };
    try {
      const res = await fetch(TICKET_API_URL, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(ticketData)
      });
      if (res.ok) {
        alert("Ticket created successfully!");
        loadTickets();
        toggleTicketForm();
        this.reset();
      } else { alert("Failed to create ticket"); }
    } catch (err) { console.error(err); }
  });

  async function loadTickets() {
    try {
      const res = await fetch(TICKET_API_URL);
      const tickets = await res.json();
      const tbody = document.getElementById("ticketsTableBody");
      tbody.innerHTML = "";
      const myTickets = tickets.filter(t => t.temail === loggedInUser.uemail);
      myTickets.forEach(ticket => {
        tbody.innerHTML += `<tr>
          <td>${ticket.tid}</td><td>${ticket.tname}</td><td>${ticket.temail}</td>
          <td>${ticket.tphone}</td><td>${ticket.tsubject}</td><td>${ticket.tmessage}</td>
        </tr>`;
      });
    } catch (e) { console.error(e); }
  }

  async function loadGallery() {
    try {
      const res = await fetch(`${GALLERY_API_URL}/customer/${loggedInUser.uemail}`);
      const zips = await res.json();
      const tbody = document.getElementById("galleryTableBody");
      tbody.innerHTML = "";

      zips.forEach(zip => {
        tbody.innerHTML += `
          <tr>
            <td>${zip.eventId || "-"}</td>
            <td>${zip.fileName}</td>
            <td>${(zip.uploadDate || "").replace("T", " ")}</td>
            <td>
              <a href="${GALLERY_API_URL}/download/${zip.id}" 
                 class="btn btn-primary" download>
                 â¬‡ Download
              </a>
            </td>
          </tr>`;
      });
    } catch (e) {
      console.error("Failed to load gallery:", e);
    }
  }

  document.getElementById("profileForm").addEventListener("submit", async function(e) {
    e.preventDefault();
    const profileData = {
      uname: document.getElementById("pname").value,
      uemail: document.getElementById("pemail").value,
      uphone: document.getElementById("pphone").value,
      upassword: document.getElementById("ppassword").value
    };
    try {
      const res = await fetch(`${PROFILE_API_URL}/${loggedInUser.uid}`, {
        method: "PUT",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(profileData)
      });
      if (res.ok) {
        alert("Profile updated successfully!");
        localStorage.setItem("loggedInUser", JSON.stringify(profileData));
        document.getElementById("welcomeText").textContent = "Welcome, " + profileData.uname;
      } else {
        alert("Failed to update profile");
      }
    } catch (err) { console.error(err); }
  });

  function logout() {
    localStorage.removeItem("loggedInUser");
    localStorage.removeItem("userRole");
    window.location.href = "login.html";
  }
</script>
</body>
</html>